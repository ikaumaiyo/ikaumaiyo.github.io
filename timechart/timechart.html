<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ＴＬじぇねれーたー</title>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.3/semantic.min.css">
<link rel="stylesheet" type="text/css" href="main.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.3/semantic.min.js"></script>
<script src="copy.js"></script>
<script>
	$(document).ready(function() {

		let charLimit = 5;
		var lineCount = 0;

		$('.prcn-char').html($('#prcn-char').html());
		$('.prcn-rank').html($('#prcn-rank').html());
		$('.prcn-star').html($('#prcn-star').html());

		$('.button-init').click(function() {
			$('.edit-area').html('');
			$('.button-line-insert').trigger('click');
		});

		$('.button-line-insert').click(function() {
			var lineTime = $('#prcn-timeline-time').html();
			var lineTimeResult = '';

			lineTimeResult = lineTime.replace(/01:30/g, getlastTime);

			var lineChar = $('#prcn-timeline-char').html();
			var lineCharResult = '';

			for (var i = 0; i < charLimit; i++) {
				var insertChar = getCharName(i);

				var _lineChar = lineChar;

				_lineChar = _lineChar.replace(/charNum/g, ('char' + i + lineCount));
				_lineChar = _lineChar.replace(/charName/g, insertChar);

				lineCharResult += _lineChar;
			}

			var lineBiko = $('#prcn-timeline-biko').html();
			var lineBikoResult = '';
			lineBikoResult = lineBiko.replace(/biko/g, 'biko' + lineCount);

			var lineDelete = $('#prcn-timeline-delete').html();
			var lineDeleteResult = '';

			lineCount += 1;

			$(".edit-area").append($("<div></div>").html(lineTimeResult + lineCharResult + lineBikoResult + lineDelete));
		});

		$(document).on("click", '.button-line-delete', function() {
			$(this).parent().remove();
		});

		$(document).on("click", '.button-export', function() {
			var result = '';

			for (var i = 0; i < charLimit; i++) {
				result += getCharName(i) + ' ';
				result += getCharStar(i) + ' ';
				result += getCharRank(i);
				result += '<br>';

			}

			result += '<br>';

			var lines = $('.edit-area').children();
			for (var i = 0; i < lines.length; i++) {
				var line = lines.eq(i);
				result += $(line).children('input[type="time"]').val() + ' ';

				var chars = $(line).children('input[type="checkbox"]');

				for (var ci = 0; ci < chars.length; ci++) {
					var chr = chars.eq(ci);
					if ($(chr).prop('checked')) {
						result += $('label[for="' + $(chr).attr('id') + '"]').html() + ' ';
					}
				}

				if ($(line).children().children('input[type="text"]').val().length > 0) {

					result += "（" + $(line).children().children('input[type="text"]').val() + '）';
				}

				result += '<br>';
			}

			$('.export-area p').html(result);

		});

		$(document).on("click", '.button-copy', function() {
			execCopy($('.export-area p').html());
		});


		$(document).on("click", '.test', function() {
			$('#char0').children('.prcn-char').children('.input').children('input').val('キャラ0');
			$('#char1').children('.prcn-char').children('.input').children('input').val('キャラ1');
			$('#char2').children('.prcn-char').children('.input').children('input').val('キャラ2');
			$('#char3').children('.prcn-char').children('.input').children('input').val('キャラ3');
			$('#char4').children('.prcn-char').children('.input').children('input').val('キャラ4');
		});


		function getCharName(num) {
			return $('#char' + num).children('.prcn-char').children('.input').children('input').val();
		}
		function getCharStar(num) {
			return $('#char' + num).children('.prcn-star').children('select').val();
		}
		function getCharRank(num) {
			return $('#char' + num).children('.prcn-rank').children('select').val();
		}
		function getlastTime() {
			var result = $('.edit-area div:last-child').children('input[type="time"]').val();
			if (result === undefined) {
				return "01:30";
			}
			return result;
		}

	});
</script>
</head>
<body>
	<!--  -->
	<!-- <button class="test">test</button> -->
	<h2 class="ui header">
		<i class="settings icon"></i>
		<div class="content">ＴＬじぇねれーたー</div>
	</h2>
	<div class="ui segment">
		<div class="ui grid">
			<div class="three wide column" id="char0">
				<div class="prcn-char"></div>
				<div class="prcn-star"></div>
				<div class="prcn-rank"></div>
			</div>
			<div class="three wide column" id="char1">
				<div class="prcn-char"></div>
				<div class="prcn-star"></div>
				<div class="prcn-rank"></div>
			</div>
			<div class="three wide column" id="char2">
				<div class="prcn-char"></div>
				<div class="prcn-star"></div>
				<div class="prcn-rank"></div>
			</div>
			<div class="three wide column" id="char3">
				<div class="prcn-char"></div>
				<div class="prcn-star"></div>
				<div class="prcn-rank"></div>
			</div>
			<div class="three wide column" id="char4">
				<div class="prcn-char"></div>
				<div class="prcn-star"></div>
				<div class="prcn-rank"></div>
			</div>
		</div>
	</div>
	<!-- init ( edit area ) -->
	<button class="ui primary button button-init">初期化 ▼</button>

	<!-- edit area -->
	<div class="ui segment">
		<div class="edit-area"></div>
		<button class="ui button button-line-insert">╋</button>
	</div>

	<!-- export -->
	<button class="ui green button button-export">テキスト出力 ▼</button>

	<!-- export area -->
	<div class="ui clearing segment export-area">
		<div class="ui green right floated button button-copy">コピー</div>
		<p>未出力</p>
	</div>

	<!-- input modules -->
	<div style="display: none;">
		<div id="prcn-char">
			<div class="ui input" style="width: 100%;">
				<input type="text" placeholder="キャラ">
			</div>
		</div>
		<div id="prcn-rank">
			<select class="ui dropdown" style="width: 100%;">
				<option value="Rank14" selected>Rank14</option>
				<option value="Rank13">Rank13</option>
				<option value="Rank12">Rank12</option>
				<option value="Rank11">Rank11</option>
			</select>
		</div>
		<div id="prcn-star">
			<select class="ui dropdown" style="width: 100%;">
				<option value="★5" selected>★5</option>
				<option value="★4" value="articles">★4</option>
				<option value="★3" value="articles">★3</option>
			</select>
		</div>
		<div id="prcn-timeline-time">
			<input type="time" value="01:30">
		</div>
		<div id="prcn-timeline-char">
			<input type="checkbox" class="charChk" id="charNum" />
			<label class="charChk" for="charNum">charName</label>
		</div>
		<div id="prcn-timeline-biko">
			<div class="ui input">
				<input type="text" placeholder="備考" id="biko">
			</div>
		</div>
		<div id="prcn-timeline-delete">
			<button class="ui button button-line-delete">×</button>
		</div>
	</div>
</body>
</html>